{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <!-- Purchase Card -->
            <div class="soft-card p-3 p-md-4">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="fw-bold">Purchase Secret Drop</h2>
                    <p class="text-muted mb-0">Pay to reveal what's hidden</p>
                </div>

                <!-- Drop Preview -->
                <div class="text-center mb-4">
                    <div class="position-relative d-inline-block">
                        <!-- Black Box Image -->
                        <img src="{% static 'images/blackbox.png' %}" 
                             class="img-fluid rounded-3 purchase-image" 
                             alt="Secret Drop"
                             style="height: 300px; object-fit: cover;">
                        
                        <!-- Lock Overlay -->
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <div class="bg-dark rounded-circle p-3 opacity-75">
                                <i class="fas fa-lock fa-2x text-light"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Drop Details -->
                <div class="mb-4">
                    <span class="fw-semibold float-start">{{ drop.title }}</span>
                     <span class="float-end">
                           {% with drop.get_creator_username as username %}
                      {% if username %}
                        @{{ username }}

                    {% endif %}
                 {% endwith %}
                    </span> <br>
                    <p class="text-muted mb-2">{{ drop.description }}</p> 
                    
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary">
                        <span class="text-muted">Price</span>
                        <span class="h5 mb-0 text-success">{{ drop.price_sol }} SOL</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary">
                        <span class="text-muted">Creator</span>
                        <span class="text-light">{{ drop.creator|slice:":8" }}...{{ drop.creator|slice:"-6:" }}</span>
                    </div>
                </div>

                <!-- Purchase Button -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg py-3 fw-semibold" 
                            onclick="initiatePurchase()"
                            id="purchase-btn"
                            data-price-sol="{{ drop.price_sol }}"
                            data-creator-wallet="{{ drop.creator }}">
                         Pay {{ drop.price_sol }} SOL to Reveal
                    </button>
                    
                    <a href="{% url 'home' %}" class="btn btn-outline-light">
                        ‚Üê Back to Drops
                    </a>
                </div>

                <!-- Loading State -->
                <div class="text-center mt-3 d-none" id="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Verifying payment...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function initiatePurchase() {
    const purchaseBtn = document.getElementById('purchase-btn');
    const loadingState = document.getElementById('loading-state');
    const priceSOL = parseFloat(purchaseBtn.dataset.priceSol);
    const creatorWallet = purchaseBtn.dataset.creatorWallet;
    //get drop price in lamports.
    const lamports = priceSOL * 1000000000
    
    LoadingState.show(purchaseBtn, 'Processing payment...');
    
    // Show loading state
    purchaseBtn.classList.add('d-none');
    loadingState.classList.remove('d-none');

    try {
        //check if wallet is connected
        if (!window.walletConnector || !window.walletConnector.walletAddress){
            throw new Error("Please connect your wallet.");
        }

        //check if solana provider is available
        if (!window.walletConnector.provider){

            if (window.solana && window.solana.isPhanton) {
                window.walletConnector.provider = window.solana;
                console.log('recconected phanton provider');
            } else { 
                throw new Error("Wallet not connected properly. Please reconnect.");
            }
        }

        // create connection to solana blockchain
        const connection = new solanaWeb3.Connection(
            solanaWeb3.clusterApiUrl('mainnet-beta'),
            'confirmed'
        );
        //create tranfer instruction
        const transferInstruction = solanaWeb3.SystemProgram.transfer({
            fromPubkey: new solanaWeb3.PublicKey(window.walletConnector.walletAddress),
            toPubkey: new solanaWeb3.PublicKey(creatorWallet),
            lamports: lamports
        });

        //create transaction
        const transaction = new solanaWeb3.Transaction().add(transferInstruction);

        //get blockhash
        const {blockhash} = await connection.getRecentBlockhash();
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = new solanaWeb3.PublicKey(window.walletConnector.walletAddress);

        //request wallet to sign and send transaction
        const signature = await window.walletConnector.provider.signAndSendTransaction(transaction);

        console.log('Transaction sent:', signature);

        //verify transaction confirmation
        const confirmation = await connection.confirmTransaction(signature, 'confirmed');

        if(confirmation.value.err){
            throw new Error('Transaction Failed: ' + confirmation.value.err);
        }
         
        LoadingState.hide(purchaseBtn);
        showSuccessToast('Payment successful! Revealing Image...')

        //payment succesful and image reveal in wallet 
        await revealImageToUser(signature);

    } catch (error){
        LoadingState.hide(purchaseBtn);
        console.error('Payment Failed: ', error);
        
        let userMessage = 'Payment failed. ';

        if (error.message.includes('User rejected')){
            userMessage += 'You rejected the transaction in your wallet.';
        } else if (error.message.includes('insufficient funds')) {
            userMessage += 'Insufficient SOL in your wallet.';
        }else if (error.message.includes('Wallet not connected')){
            userMessage += 'Please connect your wallet first.';
        }else if (error.message.includes('Phantom')){
            userMessage += 'Wallet connection issue. Refesh & try connecting again.';
        }else if(error.message.includes('429') || error.message.includes('rate limit')){
            userMessage += 'Too many requests, Please try again later.';
        } else if(error.message.includes('network')){
            userMessage += 'Network  error. Check your internet connection';
        } else if(error.message.includes('Payment system not ready')) {
            userMessage = 'Payment systm not loaded. Please: ';
            userMessage = '\n1. Check your internet connection';
            userMessage = '\n2. Refresh the page';
            userMessage = '\n3. Try again';
        }else {
            userMessage += error.message || 'Please try again';
        }

        showErrorToast(userMessage);

        //reset ui
        purchaseBtn.classList.remove('d-none')
        loadingState.classList.add('d-none');
    } 
}


async function revealImageToUser(transactionSignature){
    try{
        //call django backend to verify and reveal
        const response = await fetch('/api/drop/{{drop.id}}/reveal/',{
            method : 'POST',
            headers : {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body : JSON.stringify({
                transaction_signature: transactionSignature,
                buyer_wallet: window.walletConnector.walletAddress
            })
        
    });

    const result = await response.json();

    if (result.status === 'success'){
        //show revealed img
        showRevealedImage(result.revealed_image_url, result.is_unique);
    } else {
        throw new Error(result.message);

    }

    } catch (error) {
        console.error('Reveal Failed', error);
        alert('Reveal Failed: ' + error.message);
    }
} 

function showRevealedImage(imageUrl, isUnique){ 
    //replace purchase page with the revealed image
    document.querySelector('main').innerHTML = `
    
<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="soft-card p-4 text-center">
                <h2 class="text-success mb-4"> Secret Revealed! </h2>
                
                <!--reveal img-->
                <img src="${imageUrl}" alt="Revealed Art" class="img-fluid rounded-3 mb-4 revealed-image" style="max-height: 500px; object-fit: contain;">
                
                <!--download btn-->
                <a href="${imageUrl}" download class="btn btn-success btn-md mb-3">

                    Download Your Secret Drop.

                </a>
                   ${isUnique ?'<p class="text-bg-warning"> This is aunique 1/1 edition - you own the only copy </p>':' '}

                <a href="{% url 'home' %}" class="btn btn-outline-light">

                    Back to Marketplace

                </a>
                </div>

            </div>

        </div>

    </div>
    `;
}
// get csrf token
function getCSRFToken(){
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}


//preserving connection
document.addEventListener('DOMContentLoaded', function(){
    if (window.walletConnector && window.walletConnector.walletAddress){
        console.log('wallet connected', window.walletConnector.walletAddress);    
    }else{
        console.log('No wallet connection found');
    }
});

</script>



<style>
.purchase-image {
    max-width: 100%;
    height: auto;
    border: 2px solid var(--border-color);
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .soft-card {
        margin: 0 -10px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    .purchase-image {
        max-height: 250px !important;
    }
}

/* Button hover effects */
.btn-primary {
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
}
</style>


{% endblock %}